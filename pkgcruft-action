#!/usr/bin/env bash

# disable github action bash shell default `set -e`
set +e

run() {
	echo $@
	$@
}

# run scanning within a subshell with `set -e` enabled
(
	set -e

	# TODO: replace with native pkgcraft repo syncing functionality
	# see https://github.com/pkgcraft/pkgcruft-action/issues/2
	mkdir -p "${HOME}/.cache/pkgcruft/repos/gentoo"
	curl -sL https://github.com/gentoo-mirror/gentoo/archive/stable.tar.gz | tar -zxf - --strip-components=1 -C "${HOME}/.cache/pkgcruft/repos/gentoo"
	dir=$(mktemp -d)
	cat <<- EOF > "${dir}/repos.conf"
	[DEFAULT]
	main-repo = gentoo
	[gentoo]
	location = "${HOME}/.cache/pkgcruft/repos/gentoo"
	EOF
	sudo mv "${dir}" /etc/portage

	echo Generating metadata
	run pk repo metadata regen -p ~/.cache/pkgcraft/md5-cache ${REPO}

	# TODO: incorporate custom metadata dir into `pkgcruft scan` option
	mkdir -p "${REPO}"/metadata
	rm -rf "${REPO}"/metadata/md5-cache
	ln -s ~/.cache/pkgcraft/md5-cache "${REPO}"/metadata/md5-cache

	# forcibly enable color output
	export CLICOLOR_FORCE=1
	echo Running pkgcruft
	run pkgcruft scan ${PKGCRUFT_SCAN_OPTIONS} ${REPO}
)

status=$?
echo "exit-status=${status}" >> $GITHUB_OUTPUT

# verify expected exit status for tests
if [[ -n ${_PKGCRUFT_ACTION_EXIT_STATUS} ]]; then
	[[ ${_PKGCRUFT_ACTION_EXIT_STATUS} == ${status} ]] && exit 0
fi

exit ${status}
